//Detection rule for App Gateway rule hits for log4j vulnerability. Retrieve attacked host, malicious IP and malicious User Agent

//Data connector required for this query - Azure Diagnostics (Application Gateways)

AzureDiagnostics
| where details_data_s contains "jndi"
| parse-where details_data_s with * 'User-Agent:' MaliciousHost 
| project TimeGenerated, Target=hostname_s, Actor=clientIp_s, MaliciousHost

//Detect uri directly where starts with /$ or contains ldap
AzureDiagnostics
| where TimeGenerated > ago(1d)
| where ResourceType == "APPLICATIONGATEWAYS"
| project TimeGenerated, host_s, originalRequestUriWithArgs_s, clientIP_s
| where originalRequestUriWithArgs_s startswith "/$" or originalRequestUriWithArgs_s contains "jndi"
| parse-where originalRequestUriWithArgs_s with * '://' MaliciousHost 