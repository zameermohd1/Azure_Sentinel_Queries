//Parse all request uris over the last 30 days and create a new column from the string between / and ://
//Example - from /${jndi:ldap:// we parse ${jndi:ldap: to a new column called HeaderUri

//Data connector required for this query - Azure Diagnostics (Application Gateways)

//Look up the last 3 days of data to find any new HeaderUri strings between / and :// not seen for the previous 30 days
AzureDiagnostics
| where TimeGenerated > ago(30d) and TimeGenerated < ago(3d)
| where ResourceType == "APPLICATIONGATEWAYS"
| project TimeGenerated, host_s, originalRequestUriWithArgs_s, clientIP_s
| parse-where originalRequestUriWithArgs_s with * '/' HeaderUri '://' *
| distinct host_s, HeaderUri
| join kind=rightanti (
    AzureDiagnostics
    | where TimeGenerated > ago(3d)
    | where ResourceType == "APPLICATIONGATEWAYS"
    | project TimeGenerated, host_s, originalRequestUriWithArgs_s, clientIP_s
    | parse-where originalRequestUriWithArgs_s with * '/' HeaderUri '://' *
    | project TimeGenerated, originalRequestUriWithArgs_s, host_s, HeaderUri)
    on host_s, HeaderUri
| parse-where originalRequestUriWithArgs_s with * '://' MaliciousHost '/' *
| project TimeGenerated, originalRequestUriWithArgs_s, HeaderUri, MaliciousHost, Target=host_s